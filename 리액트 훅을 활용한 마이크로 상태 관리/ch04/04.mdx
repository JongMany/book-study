# êµ¬ë…ì„ ì´ìš©í•œ ëª¨ë“ˆ ìƒíƒœ ê³µìœ 

ì»¨í…ìŠ¤íŠ¸ëŠ” ì‹±ê¸€í„´ íŒ¨í„´ì„ í”¼í•˜ê³ , ê° í•˜ìœ„ íŠ¸ë¦¬ì— ì„œë¡œ ë‹¤ë¥¸ ê°’ì„ ì œê³µí•˜ê¸° ìœ„í•œ ê¸°ëŠ¥ì„

**ì „ì—­ ìƒíƒœë¥¼ ì‹±ê¸€í„´ê³¼ ìœ ì‚¬í•˜ê²Œ ë§Œë“¤ê³ ì í•œë‹¤ë©´?**

<u>ëª¨ë“ˆ ìƒíƒœ</u>ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì‹±ê¸€í„´ ê°’ìœ¼ë¡œ ë©”ëª¨ë¦¬ì— í• ë‹¹ë˜ê¸° ë•Œë¬¸ì— ë”
ì í•©í•¨

ëª¨ë“ˆ ìƒíƒœë€? ECMAScript ëª¨ë“ˆ ìŠ¤ì½”í”„ì— ì •ì˜ëœ ìƒìˆ˜ ë˜ëŠ” ë³€ìˆ˜ë¥¼ ë§í•¨

ë¦¬ì•¡íŠ¸ì—ì„œ ëª¨ë“ˆ ìƒíƒœë¥¼ ì „ì—­ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” `subscription`ì„ ì‚¬ìš©í•´ì•¼ í•¨

---

### **ëª¨ë“ˆ ìƒíƒœ ì‚´í´ë³´ê¸° in JS**

ëª¨ë“ˆ ìƒíƒœ(module state)ëŠ” ëª¨ë“ˆ ìˆ˜ì¤€ì—ì„œ ì •ì˜ëœ ë³€ìˆ˜. â¡ï¸ ëª¨ë“ˆì€ ES ëª¨ë“ˆ, ë˜ëŠ” íŒŒì¼ì„ ì˜ë¯¸í•¨

(1) ëª¨ë“ˆ ìƒíƒœ ì •ì˜í•˜ê¸°

```js
let state = {
  count: 0,
};
```

(2) ëª¨ë“ˆ ìƒíƒœì— ì ‘ê·¼í•˜ëŠ” í•¨ìˆ˜ ë§Œë“¤ê¸°

```js
export const getState = () => state;

export const setState = (nextState) => {
  state = nextState;
};
```

setState í•¨ìˆ˜ì˜ ì¸ìë¡œ í•¨ìˆ˜ê°€ ë“¤ì–´ì˜¬ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë¦¬íŒ©í† ë§

```js
export const setState = (nextState) => {
  state = typeof nextState === "function" ? nextState(state) : nextState;
};
```

(3) ì»¨í…Œì´ë„ˆë¡œ ê°ì‹¸ê¸°
ëª¨ë“ˆ ìƒíƒœë¥¼ ì§ì ‘ ì •ì˜í•˜ëŠ” ëŒ€ì‹ , ìƒíƒœì™€ ìƒíƒœì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” í•¨ìˆ˜ê°€ ë‚´ë¶€ì— ìˆëŠ” ì»¨í…Œì´ë„ˆë¥¼ ë§Œë“¤ê¸°

```js
export const createContainer = (initialState) => {
  let state = initialState;
  const getState = () => state;
  const setState = (nextState) => {
    state = typeof nextState === "function" ? nextState(state) : nextState;
  };
  return { getState, setState };
};
```

ì´ë ‡ê²Œ ì •ì˜í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì‚¬ìš© ê°€ëŠ¥

```js
const { getState, setState } = createContainer({ count: 0 });
```

---

### **ë¦¬ì•¡íŠ¸ì—ì„œ ì „ì—­ ìƒíƒœë¥¼ ë‹¤ë£¨ê¸° ìœ„í•œ ëª¨ë“ˆ ìƒíƒœ ì‚¬ìš©ë²•**

ë¦¬ì•¡íŠ¸ ì»¨í…ìŠ¤íŠ¸ëŠ” í•˜ìœ„ íŠ¸ë¦¬ì— ë”°ë¼ ê°ê° ë‹¤ë¥¸ ê°’ì„ ì œê³µí•˜ë„ë¡ ì„¤ê³„ë˜ì–´ ìˆìŒ.  
ì‹±ê¸€í„´ ì „ì—­ ìƒíƒœì— ëŒ€í•´ ë¦¬ì•¡íŠ¸ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒë„ ê°€ëŠ¥í•˜ì§€ë§Œ ì»¨í…ìŠ¤íŠ¸ì˜ ê¸°ëŠ¥ì„ ì™„ì „í•˜ê²Œ í™œìš©í•œ ê²ƒì€ ì•„ë‹˜

ì „ì²´ íŠ¸ë¦¬ì—ì„œ ì „ì—­ ìƒíƒœê°€ í•„ìš”í•˜ë‹¤ë©´ ëª¨ë“ˆ ìƒíƒœê°€ ë” ì í•©í•˜ì§€ë§Œ ë¦¬ì•¡íŠ¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ ëª¨ë“ˆ ìƒíƒœë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë¦¬ë Œë”ë§ ìµœì í™”ë¥¼ ì§ì ‘ ì²˜ë¦¬í•´ì•¼ í•¨

_- ì‘ë™í•˜ì§€ ì•ŠëŠ” ì˜ˆì‹œ_

```jsx
let count = 0;

const Component1 = () => {
  const inc = () => {
    count += 1;
  };

  return (
    <div>
      {count}
      <button onClick={inc}>+1</button>
    </div>
  );
};
```

ì²˜ìŒì—ëŠ” countê°€ 0ìœ¼ë¡œ í‘œì‹œë˜ê³ , ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ countê°€ ì¦ê°€í•˜ì§€ë§Œ ì»´í¬ë„ŒíŠ¸ê°€ ë¦¬ë Œë”ë§ë˜ì§€ ì•ŠìŒ.

ë¦¬ë Œë”ë§ì„ ì¼ìœ¼í‚¤ë ¤ë©´ `useState`, `useReducer` 2ê°œë§Œ ìˆìŒ

_- ì‘ë™ì‹œí‚¤ë„ë¡ ìˆ˜ì •í•˜ê¸°_

```jsx
let count = 0;

const Component1 = () => {
  const [state, setState] = useState(count);

  const inc = () => {
    count += 1;
    setState(count);
  };

  return (
    <div>
      {state}
      <button onClick={inc}>+1</button>
    </div>
  );
};

const Component2 = () => {
  const [state, setState] = useState(count);

  const inc2 = () => {
    count += 2;
    setState(count);
  };

  return (
    <div>
      {state}
      <button onClick={inc}>+1</button>
    </div>
  );
};
```

ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ count ê°’ì´ ì¦ê°€í•˜ê³ , ì»´í¬ë„ŒíŠ¸ê°€ ë¦¬ë Œë”ë§ë¨
ë‹¨, `Component1`ì—ì„œ ë²„íŠ¼ì„ í´ë¦­í•˜ë”ë¼ë„ `Component2`ê°€ ë¦¬ë Œë”ë§ë˜ì§€ ì•ŠìŒ.
`Component2`ì—ì„œ ë²„íŠ¼ì„ í´ë¦­í•´ì•¼ë§Œ ë¦¬ë Œë”ë§ë˜ê³  ìµœì‹  ëª¨ë“ˆ ìƒíƒœê°€ í‘œì‹œë¨.
ì¦‰, `Component1`ê³¼ `Component2`ì˜ ìƒíƒœê°€ ì¼ì¹˜í•¨.
ë‘ ê°œì˜ `Component1` ì»´í¬ë„ŒíŠ¸ë¥¼ ì‚¬ìš©í•˜ë”ë¼ë„ ë¶ˆì¼ì¹˜ê°€ ë°œìƒí•¨

**í•´ê²°ì±…** Component1ê³¼ Component2ì—ì„œ ë™ì‹œì— setState í•¨ìˆ˜ë¥¼ í˜¸ì¶œ (ğŸ˜¨ Bad)

ì»´í¬ë„ŒíŠ¸ ìƒëª… ì£¼ê¸°ë¥¼ ê³ ë ¤í•˜ë©´ì„œ ì»´í¬ë„ŒíŠ¸ ì™¸ë¶€ì— ìˆëŠ” ëª¨ë“ˆ ìˆ˜ì¤€ì—ì„œ `setState`ë¥¼ ê´€ë¦¬í•  í•„ìš”ê°€ ìˆìŒ  
â¡ï¸ ì»´í¬ë„ŒíŠ¸ ìƒëª… ì£¼ê¸°ì— ë”°ë¼ ë™ì‘í•˜ëŠ” `useEffect` í›…ì„ ì´ìš©í•´ `setState`ë¥¼ ë¦¬ì•¡íŠ¸ ì™¸ë¶€ì— `Set`ê³¼ ê°™ì€ ë³„ë„ì˜ ìë£Œêµ¬ì¡°ì— ì¶”ê°€í•´ì„œ ê´€ë¦¬

```jsx
let count = 0;
const setStateFunctions = new Set<(count: number) => void>();

const Component1 = () => {
  const [state, setState] = useState(0);

  useEffect(() => {
    setStateFunctions.add(setState);
    return () => {
      setStateFunctions.delete(setState);
    };
  }, []);

  const inc = () => {
    count += 1;
    setStateFunctions.forEach((fn) => fn(count));
  }

  return (
    <div>
      {state}
      <button onClick={inc}>+1</button>
    </div>
  );
}


const Component2 = () => {
  const [state, setState] = useState(0);

  useEffect(() => {
    setStateFunctions.add(setState);
    return () => {
      setStateFunctions.delete(setState);
    };
  }, []);

  const inc2 = () => {
    count += 2;
    setStateFunctions.forEach((fn) => fn(count));
  }

  return (
    <div>
      {state}
      <button onClick={inc2}>+2</button>
    </div>
  );
}
```

ì¤‘ë³µ ì½”ë“œê°€ ë°œìƒí•˜ì˜€ê¸°ë„ í•˜ë©°, ë°”ë¼ë´ì•¼í•  ì»´í¬ë„ŒíŠ¸ê°€ ë§ì•„ì§ˆìˆ˜ë¡ ê´€ë¦¬ê°€ ì–´ë ¤ì›Œì§

---

### **ê¸°ì´ˆì ì¸ êµ¬ë… ì¶”ê°€í•˜ê¸°**

êµ¬ë…: ê°±ì‹ ì— ëŒ€í•œ ì•Œë¦¼ì„ ë°›ê¸° ìœ„í•œ ë°©ë²•

êµ¬ë…ì˜ ì¼ë°˜ì ì¸ íŒ¨í„´

```js
const unsubscribe = store.subscribe(() => {
  console.log("Store is Updated!");
});
```

- `store`ì—ëŠ” `subscribe` ë©”ì„œë“œê°€ ìˆìŒ.  
  ë©”ì„œë“œëŠ” `callback` í•¨ìˆ˜ë¥¼ ë°›ê³ , `unsubscribe` í•¨ìˆ˜ê°€ ë°˜í™˜ë¨  
  `store`ê°€ ê°±ì‹ ë  ë•Œë§ˆë‹¤ ì½œë°±í•¨ìˆ˜ê°€ í˜¸ì¶œë¨

(1) êµ¬ë… íŒ¨í„´ìœ¼ë¡œ ëª¨ë“ˆ ìƒíƒœë¥¼ êµ¬í˜„í•˜ê¸°

```ts
type Store<T> = {
  getState: () => T;
  setState: (action: T | ((prev: T) => T)) => void;
  subscribe: (callback: () => void) => () => void;
};

const createStore = <T extends unknown>(initialState: T): Store<T> => {
  let state = initialState;
  const callbacks = new Set<() => void>();
  const getState = () => state;
  const setState = (action: T | ((prev: T) => T)) => {
    state =
      typeof action === "function"
        ? (nextState as (prev: T) => T)(state)
        : nextState;

    callbacks.forEach((callback) => callback());
  };

  const subscribe = (callback: () => void) => {
    callbacks.add(callback);
    return () => {
      callbacks.delete(callback);
    };
  };

  return { getState, setState, subscribe };
};
```

(2) Vanilla JSì—ì„œ êµ¬ë… íŒ¨í„´ ì‚¬ìš©í•˜ê¸°

```js
import { createStore } from "...";

const store = createStore({ count: 0 });
console.log(store.getStore());
store.setState({ count: 1 });
store.subscribe(() => {
  console.log("Store is Updated!");
});
```

- `store` ë³€ìˆ˜ëŠ” `state`ë¥¼ ë‹´ê³  ìˆìœ¼ë¯€ë¡œ `store` ë³€ìˆ˜ ì „ì²´ë¥¼ ëª¨ë“ˆ ìƒíƒœë¼ê³  ë³¼ ìˆ˜ ìˆìŒ

(3) Reactì—ì„œ êµ¬ë… íŒ¨í„´ ì‚¬ìš©í•˜ê¸°

```js
// 1. ì»¤ìŠ¤í…€ í›… ì •ì˜ - storeì˜ ìƒíƒœê°’ê³¼ ê°±ì‹ í•¨ìˆ˜ë¥¼ íŠœí”Œë¡œ ë°˜í™˜
const useStore = (store) => {
  const [state, setState] = useState(store.getState());
  useEffect(() => {
    const unsubscribe = store.subscribe(() => {
      setState(store.getState());
    });
    setState(store.getState()); // ì—£ì§€ì¼€ì´ìŠ¤ë¥¼ ë‹¤ë£¨ê¸° ìœ„í•œ ì½”ë“œ (useEffectê°€ ë’¤ëŠ¦ê²Œ ì‹¤í–‰ë˜ì–´ storeê°€ ì´ë¯¸ ìƒˆë¡œìš´ ìƒíƒœë¥¼ ê°€ì§€ê³  ìˆì„ ê°€ëŠ¥ì„±ì´ ìˆìœ¼ë¯€ë¡œ)
    return unsubscribe;
  }, [store]);

  return [state, store.setState];
};
```

```jsx
// 2. ì»´í¬ë„ŒíŠ¸ì—ì„œ ì»¤ìŠ¤í…€ í›… ì‚¬ìš©í•˜ê¸°
const Component1 = () => {
  const [state, setState] = useStore(store);

  const inc = () => {
    setState((prev) => ({
      ...prev,
      count: prev.count + 1,
    }));
  };

  return (
    <div>
      {state.count}
      <button onClick={inc}>+1</button>
    </div>
  );
};

const Component2 = () => {
  const [state, setState] = useStore(store);

  const inc2 = () => {
    setState((prev) => ({
      ...prev,
      count: prev.count + 2,
    }));
  };

  return (
    <div>
      {state.count}
      <button onClick={inc2}>+2</button>
    </div>
  );
};

const App = () => {
  return (
    <div>
      <Component1 />
      <Component2 />
    </div>
  );
};
```

---

### **ì„ íƒìì™€ useSubscription ì‚¬ìš©í•˜ê¸°**

useStoreëŠ” ìƒíƒœ ê°ì²´ ì „ì²´ë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ ì»´í¬ë„ŒíŠ¸ê°€ ë¶ˆí•„ìš”í•˜ê²Œ ë¦¬ë Œë”ë§ë  ìˆ˜ ìˆìŒ  
í•„ìš”ì—†ëŠ” ë¦¬ë Œë”ë§ì„ í”¼í•˜ê¸° ìœ„í•´ ì»´í¬ë„ŒíŠ¸ê°€ í•„ìš”ë¡œ í•˜ëŠ” ìƒíƒœì˜ ì¼ë¶€ë¶„ë§Œ ë°˜í™˜í•˜ëŠ” ì„ íƒìë¥¼ ë„ì…í•˜ê¸°

(1) ì„ íƒìë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒíƒœ ê°ì²´ì˜ ì¼ë¶€ë§Œ ë°˜í™˜í•˜ê¸° (`useStoreSelector`)

```js
const store = createStore({ count1: 0, count2: 0 });

const useStoreSelector = <T, S>(store: Store<T>, selector: (state: T) => S) => {
  const [state, setState] = useState(selector(store.getState()));

  useEffect(() => {
    const unsubscribe = store.subscribe(() => {
      setState(selector(store.getState()));
    });
    setState(selector(store.getState()));
    return unsubscribe;
  }, [store, selector]);

  return state;
};
```

useStoreì™€ ë‹¬ë¦¬ ì „ì²´ ìƒíƒœ ê°ì²´ë¥¼ ë°˜í™˜í•˜ëŠ” ëŒ€ì‹  ì„ íƒì í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒíƒœ ê°ì²´ì˜ ì¼ë¶€ë¶„ë§Œ ë°˜í™˜í•¨

(2) `useStoreSelector`ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒíƒœ ê°ì²´ì˜ ì¼ë¶€ë§Œ ë°˜í™˜í•˜ê¸°

```jsx
const Component1 = () => {
  const state = useStoreSelector(
    store,
    useCallback((state) => state.count1, [])
  );

  const inc = () => {
    store.setState((prev) => ({
      ...prev,
      count1: prev.count1 + 1,
    }));
  };

  return (
    <div>
      count1: {state}
      <button onClick={inc}>+1</button>
    </div>
  );
};
```

- ì•ˆì •ì ìœ¼ë¡œ ì„ íƒì í•¨ìˆ˜ë¥¼ ë„˜ê¸°ê¸° ìœ„í•´ useCallbackì„ ì‚¬ìš©í•¨.  
  `useCallback`ì„ ì‚¬ìš©í•˜ì§€ ì•Šì€ ê²½ìš°, ì„ íƒì í•¨ìˆ˜ì˜ `useEffect`ì˜ ë‘ë²ˆì§¸ ì¸ìˆ˜ì— ì„ íƒì í•¨ìˆ˜ê°€ ì§€ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì„ íƒì í•¨ìˆ˜ë¥¼ ë°”ê¾¸ì§€ ì•Šë”ë¼ë„ `Component1`ì„ ë Œë”ë§í•  ë•Œë§ˆë‹¤ storeë¥¼ êµ¬ë… í•´ì œí•˜ê³  êµ¬ë…í•˜ëŠ” ê²ƒì„ ë°˜ë³µí•˜ê²Œ ë¨

```jsx
const selectCount2 = (state: ReturnType<typeof store.getState>) => state.count2;

const Component2 = () => {
  const state = useStoreSelector(store, selectCount2);

  const inc2 = () => {
    store.setState((prev) => ({
      ...prev,
      count2: prev.count2 + 2,
    }));
  };

  return (
    <div>
      count2: {state}
      <button onClick={inc2}>+1</button>
    </div>
  );
};
```

```jsx
const App = () => {
  return (
    <div>
      <Component1 />
      <Component1 />
      <Component2 />
      <Component2 />
    </div>
  );
};
```

ì£¼ì˜í•  ì : `store` ë˜ëŠ” `selector`ê°€ ë³€ê²½ë  ë•Œ, `useEffect`ê°€ ì¡°ê¸ˆ ëŠ¦ê²Œ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— ì¬êµ¬ë…ë  ë•Œê¹Œì§€ëŠ” ê°±ì‹ ë˜ê¸° ì´ì „ ìƒíƒœ ê°’ì„ ë°˜í™˜í•œë‹¤ëŠ” ì ì´ ìˆë‹¤.
=> ë¦¬ì•¡íŠ¸ íŒ€ì€ ì´ëŸ¬í•œ ì‚¬ìš©ì‚¬ë¡€ì— ëŒ€í•´ `useSubscription`ì´ë¼ëŠ” ê³µì‹ì ì¸ í›…ì„ ì œê³µ (React 18ì—ì„œëŠ” `useSyncExternalStore`ë¡œ ë³€ê²½ë¨)

(3) useSubscription ì‚¬ìš©í•˜ê¸°

```jsx
const useStoreSelector = (store, selector) =>
  useSubscription(
    useMemo(
      () => ({
        getCurrentValue: () => selector(store.getState()),
        subscribe: store.subscribe,
      }),
      [store, selector]
    )
  );
```

ìœ„ì™€ ê°™ì´ ìˆ˜ì •í•´ë„ ë˜ì§€ë§Œ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì§ì ‘ `useSubscription`ì„ ì‚¬ìš©í•´ë„ ë¨

```jsx
const Component1 = () => {
  const state = useSubscription(
    useMemo(
      () => ({
        getCurrentValue: () => store.getState().count1,
        subscribe: store.subscribe,
      }),
      [store]
    )
  );

  const inc = () => {
    store.setState((prev) => ({
      ...prev,
      count1: prev.count1 + 1,
    }));
  };

  return (
    <div>
      count1: {state}
      <button onClick={inc}>+1</button>
    </div>
  );
};
```

- useMemoë¥¼ ì‚¬ìš©í–ˆìœ¼ë¯€ë¡œ, useCallbackì€ í•„ìš”í•˜ì§€ ì•ŠìŒ.
